# ZETDC Platform — Render Deployment Guide

This guide walks you through deploying the ZETDC Platform (Django backend + React frontend) to **Render**.

## Overview

- **Backend**: Django app on Render (Web Service)
- **Database**: PostgreSQL on Render
- **Frontend**: React app on Vercel (can also use Render Static Site)

---

## Prerequisites

1. **GitHub Account** — Your repo must be pushed to GitHub (it is: `RoyalCodePlague/zetdc_platform_app`)
2. **Render Account** — Sign up at https://render.com (free tier available)
3. **Vercel Account** — For the frontend (or use Render Static Site instead)

---

## Step 1: Push Latest Changes to GitHub

Ensure your code (including `render.yaml` and CORS middleware) is pushed:

```bash
git add .
git commit -m "Add Render deployment config and CORS middleware fixes"
git push origin main
```

---

## Step 2: Deploy Backend to Render

### 2.1 Create a Web Service

1. Go to https://dashboard.render.com
2. Click **New +** → **Web Service**
3. Select **Build and deploy from a Git repository**
4. Connect your GitHub account (if not already connected)
5. Search for and select your repository: `zetdc_platform_app`
6. Fill in the deployment form:

   | Field | Value |
   |-------|-------|
   | **Name** | `zetdc-backend` |
   | **Runtime** | `Python 3.11` |
   | **Build Command** | Leave empty (Render will read `render.yaml`) |
   | **Start Command** | Leave empty (Render will read `render.yaml`) |
   | **Branch** | `main` |
   | **Plan** | Free (or Paid if you prefer) |

7. Click **Create Web Service**

### 2.2 Configure Environment Variables

After the service is created, go to the **Environment** tab and add:

| Key | Value | Notes |
|-----|-------|-------|
| `DEBUG` | `False` | Never `True` in production |
| `DJANGO_SETTINGS_MODULE` | `backend.settings` | Points to settings file |
| `SECRET_KEY` | *(auto-generated by Render)* | Render generates this; keep it |
| `ALLOWED_HOSTS` | `*.render.com,*.onrender.com,your-domain.com` | Replace with your custom domain if you have one |

**Note**: `DATABASE_URL` is auto-set by Render when you attach the database (see Step 3).

### 2.3 First Deploy

Render will automatically trigger a build from `render.yaml`. Monitor the **Logs** tab. It should:

1. Install dependencies (`pip install -r requirements.txt`)
2. Collect static files (`python manage.py collectstatic --noinput`)
3. Run migrations (`python manage.py migrate`)
4. Start Gunicorn

Once deployed, you'll get a URL like: `https://zetdc-backend.onrender.com`

---

## Step 3: Attach PostgreSQL Database

### 3.1 Create a PostgreSQL Instance

1. In Render Dashboard, click **New +** → **PostgreSQL**
2. Fill in:

   | Field | Value |
   |-------|-------|
   | **Name** | `zetdc-db` |
   | **Database** | `zetdc` |
   | **User** | `zetdc_user` |
   | **Region** | Choose closest to you |
   | **Plan** | Free (or higher if needed) |

3. Click **Create Database**

### 3.2 Connect Database to Backend Service

1. Go back to your `zetdc-backend` Web Service
2. Click **Environment** tab
3. Click **Connect a Database** (or scroll to **Database**)
4. Select `zetdc-db` from the dropdown
5. Render will auto-populate `DATABASE_URL`

---

## Step 4: Update Frontend (Vercel or Render Static)

### Option A: Keep Frontend on Vercel (Recommended)

1. Go to your Vercel project dashboard
2. Go to **Settings** → **Environment Variables**
3. Update or create:

   | Key | Value | Environment |
   |-----|-------|-------------|
   | `VITE_API_URL` | `https://zetdc-backend.onrender.com/api` | Production |

4. **Redeploy** the frontend (go to **Deployments** → click the latest → **Redeploy**)

### Option B: Deploy Frontend to Render Static Site

1. In Render Dashboard, click **New +** → **Static Site**
2. Connect your GitHub repo
3. Fill in:

   | Field | Value |
   |-------|-------|
   | **Name** | `zetdc-frontend` |
   | **Branch** | `main` |
   | **Build Command** | `cd frontend && npm install && npm run build` |
   | **Publish Directory** | `frontend/dist` |

4. Add environment variable:
   - Key: `VITE_API_URL`
   - Value: `https://zetdc-backend.onrender.com/api`

5. Click **Create Static Site**

---

## Step 5: Update Backend CORS Settings

Update `backend/settings.py` to allow your frontend's new URL:

```python
CORS_ALLOWED_ORIGINS = [
    'https://zetdc-frontend.onrender.com',  # or your Vercel domain
    'https://zetdc-frontend.vercel.app',
    'http://localhost:5173',
    'http://localhost:3000',
]

CSRF_TRUSTED_ORIGINS = [
    'https://zetdc-frontend.onrender.com',
    'https://zetdc-frontend.vercel.app',
    'http://localhost:5173',
    'http://localhost:3000',
]
```

Then push to GitHub:

```bash
git add backend/settings.py
git commit -m "Update CORS for Render deployment"
git push origin main
```

Render will auto-redeploy when it detects changes on `main`.

---

## Step 6: Verify Deployment

### Test Backend Health

```bash
curl https://zetdc-backend.onrender.com/health/
# Expected response: {"status": "ok", "message": "Server is running"}
```

### Test API Endpoint

```bash
curl -X OPTIONS \
  -H "Origin: https://zetdc-frontend.onrender.com" \
  -H "Access-Control-Request-Method: POST" \
  -H "Access-Control-Request-Headers: content-type, authorization" \
  https://zetdc-backend.onrender.com/api/users/
# Expected: HTTP 200 with Access-Control-Allow-Origin header
```

### Test Frontend

1. Visit your frontend URL (Vercel or Render Static)
2. Try to sign up or login
3. Check browser DevTools → Network tab for preflight (OPTIONS) requests
4. Confirm `Access-Control-Allow-Origin` header is present in responses

---

## Common Issues & Fixes

### Issue: "No 'Access-Control-Allow-Origin' header"

**Solution**: Verify that:
1. Your frontend origin is in `CORS_ALLOWED_ORIGINS` in `backend/settings.py`
2. The CORS middleware is registered (should be first in `MIDDLEWARE` list)
3. You've pushed changes and Render has redeployed

### Issue: Database Connection Fails

**Solution**:
1. Check `DATABASE_URL` is set in Environment Variables
2. Verify the PostgreSQL instance is running (check Render Dashboard)
3. Look at backend logs for connection errors

### Issue: Static Files Return 404

**Solution**:
1. Ensure `STATIC_URL = '/static/'` and `STATIC_ROOT` are set in `backend/settings.py`
2. Run `python manage.py collectstatic --noinput` locally to test
3. Check Render logs for errors during the build step

### Issue: Free-Tier Database Spins Down

**Solution**:
- Render free tier PostgreSQL spins down after 15 mins of inactivity
- Consider upgrading to a paid plan or add a wake-up ping (optional)

---

## Environment Variables Checklist

### Backend (Render Web Service)

- ✅ `DEBUG` = `False`
- ✅ `DJANGO_SETTINGS_MODULE` = `backend.settings`
- ✅ `DATABASE_URL` = *(auto-set by Render)*
- ✅ `SECRET_KEY` = *(auto-generated)*
- ✅ `ALLOWED_HOSTS` = `*.onrender.com` (or your domain)

### Frontend (Vercel or Render Static)

- ✅ `VITE_API_URL` = `https://zetdc-backend.onrender.com/api`

---

## Next Steps

1. Monitor **Render Logs** for errors: Dashboard → Web Service → **Logs** tab
2. Monitor **Frontend Logs** (Vercel or Render)
3. Test all critical flows:
   - User registration
   - Login / token refresh
   - Meter list retrieval
   - Token purchase
   - Recharge flow
4. Set up error tracking (optional): Sentry, LogRocket, or similar

---

## Useful Render Commands / Resources

- **View Backend Logs**: Render Dashboard → `zetdc-backend` → **Logs**
- **Trigger Manual Redeploy**: Dashboard → Web Service → **Manual Deploy** button
- **SSH into Web Service**: `render logs -f <service-id>` (via Render CLI)
- **Database Management**: Use a DB client (DBeaver, pgAdmin) with connection string from Render

---

## Cleanup (Optional)

If you want to keep Railway running in parallel for a smooth transition:

1. Update frontend `.env.production` to point to **both** backends (load balancer, or A/B test)
2. Gradually shift traffic from Railway to Render
3. Once confident, disable/delete Railway services

Alternatively, delete Railway services immediately after confirming Render is working.

---

For questions or issues, refer to:
- [Render Documentation](https://render.com/docs)
- [Django Deployment Guide](https://docs.djangoproject.com/en/5.2/howto/deployment/)
- [Your Project README](./README.md)
